<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KML Extractor</title>

    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
        integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="columns">
            <div class="column">

            </div>
            <div class="column">
                <form action="/file" method="POST" enctype="multipart/form-data">
                    <div class="file is-warning is-boxed">
                        <label class="file-label">
                            <input class="file-input" type="file" name="file">
                            <span class="file-cta">
                                <span class="file-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </span>
                                <span class="file-label">
                                    Aguardando o arquivo KML
                                </span>
                            </span>
                        </label>
                    </div> 
                    <br>

                    <input class="button is-info" type="submit" value="upload">
                    

                </form>
                <button class="button update">Atualizar</button>
                <br>

                <h2 class="subtitle">Coordenadas:</h2>
                <ul></ul>
            </div>
            
            <div class="column">

            </div>
        </div>
    </div>


    <script>

        $('.update').click(function fetchData() {
            setTimeout(function () {
                filterXML();

            }, 3000);
        })

        function filterXML() {

            $(".title").text('Carregando...')

            $.ajax({
                type: "GET",
                url: "./static/file.kml",
                dataType: "xml",
                error: function (e) {
                    alert("An error occurred while processing XML file");
                    console.log("XML reading Failed: ", e);

                },

                success: function (response) {

                    $("ul").children().remove();

                    $(response).find('Point').each(function () {
                        var lat_long = $(this).find('coordinates').text();

                        function formatToCoordenate(coordenateToSplit, separator) {
                            const coordinatesArray = coordenateToSplit.split(separator)
                            const coordinateReversed = coordinatesArray.reverse()

                            coordinateReversed.shift()

                            const lat = coordinateReversed[0]
                            const long = coordinateReversed[1]

                            const coordinate = `${lat}, ${long}`

                            $(`<li>${coordinate}</li>`).appendTo('ul')

                            console.log(coordinate)

                        }

                        let comma = ','
                        formatToCoordenate(lat_long, comma)

                    })

                    $(".title").text('Concluido!')

                    setTimeout(() => {
                        $(".title").fadeOut()
                        $(".title").tex('Carregar arquivo:').fadeIn()

                    }, 2000)

                }

            })
        }

    </script>

</body>

</html>